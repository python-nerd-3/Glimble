{% extends 'videos/base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load humanize %}
{% load count %}
{% load tz %}

{% block content %}
	<style>
		.cool-div {
			{% if post.uploader.customisation.text_shadow_color %}
			text-shadow: 0 0 5px {{ post.uploader.customisation.text_shadow_color }}, 0 0 5px {{ post.uploader.customisation.text_shadow_color }}, 0 0 5px {{ post.uploader.customisation.text_shadow_color }};
			{% else %}
			text-shadow: 0 0 5px #ffffff, 0 0 5px #ffffff, 0 0 5px #ffffff;
			{% endif %}
			{% if post.uploader.customisation.banner_image %}
			background-image: url(https://media.glomble.com/{{ post.uploader.customisation.banner_image.name }});
			{% endif %}
			{% if post.uploader.customisation.background_color %}
			background-color: {{ post.uploader.customisation.background_color }};
			{% else %}background-color: white;
			{% endif %}
			{% if post.uploader.customisation.text_color %}
			color: {{ post.uploader.customisation.text_color }};
			{% else %}
			color: #000000;
			{% endif %}
		}
		
		.cool-element {
			{% if post.uploader.customisation.text_shadow_color %}
			text-shadow: 0 0 5px {{ post.uploader.customisation.text_shadow_color }}, 0 0 5px {{ post.uploader.customisation.text_shadow_color }}, 0 0 5px {{ post.uploader.customisation.text_shadow_color }};
			{% else %}
			text-shadow: 0 0 5px #ffffff, 0 0 5px #ffffff, 0 0 5px #ffffff;
			{% endif %}
			{% if post.uploader.customisation.text_color %}
			color: {{ post.uploader.customisation.text_color }};
			{% endif %}
		}

		.highlight {
			{% if post.uploader.customisation.background_color %}
			background-color: {{ post.uploader.customisation.background_color }};
			-webkit-filter: invert(100%);
			{% else %}
			background-color: #000000;
			{% endif %}
			transition: background-color 1s ease;
		}
		/* in my IDE syntax highlighting bugs out on this file, but this comment line fixes it... wtf */
	</style>
	<head>
		<meta property="og:title" content="{{ post.title }}">
		<meta property="og:type" content="video.other">
		<meta property="og:url" content="https://{{ request.META.HTTP_HOST }}{% url 'video-detail' post.id %}">
		<meta property="og:image" content="https://media.glomble.com/{{ post.thumbnail }}">
		<meta property="og:video" content="https://media.glomble.com/{{ post.video_file }}">
		<meta property="og:video:type" content="video/mp4">
	</head>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<div class="cool-div" style="min-height: 100vh;">
		<div class="container" id="post-container">
					<div class="row">
								<video class="mt-5" src="https://media.glomble.com/{{ post.video_file }}" type="video/mp4" style="max-height:40vw; background-color: black !important;" controls autoplay>
								</video>
					</div>
					<h5 class="mt-4">{{ post.title }} {% if post.unlisted %}<i class='bx bx-ghost' title="Unlisted"></i>{% endif %}
						{% if not user.is_anonymous and post.uploader.username != user %}
						{% can_recommend post.id user as can %}
						<button class="recommend-button cool-element btn {% if can %}btn-outline-success{% else %}btn-outline-danger{% endif %}" data-url="{% url 'video-recommend' post.id %}">
							<span>
								{% if can %}
								Recommend
								{% else %}
								Unrecommend
								{% endif %}
							</span>
						</button>
						{% video_nomination user as nomination %}
						{% now 'n' as month %}
						{% if month == '12' and can_nominate %}
						<button class="nominate-button btn {% if nomination == None %}btn-success{% elif nomination != post %}btn-warning{% else %}btn-danger{% endif %}" style="text-shadow: 0 0 5px #FFFF00, 0 0 5px #FFFF00, 0 0 5px #FFFF00; color: white" data-url="{% url 'video-nominate' post.id %}">
							<span>
								{% if nomination == None %}
								Nominate for video of the year
								{% elif nomination != post %}
								Replace current nomination
								{% else %}
								Remove nomination
								{% endif %}
							</span>
						</button>
						{% endif %}
						{% endif %}
						{% if post.uploader.username == user %}
							<a style="float: right;" class="cool-element btn cool-element btn-outline-danger" href="{% url 'video-delete' post.id %}">Delete</a>
							<a style="float: right;" class="cool-element btn cool-element btn-outline-primary" href="{% url 'video-update' post.id %}">Edit</a>
						{% elif request.user.is_superuser %}
							<a style="float: right;" class="cool-element btn cool-element btn-outline-danger" href="{% url 'video-delete' post.id %}">Delete</a>
						{% endif %}
					</h5>
					<h6>
						<a class="link-text cool-element" href="{% url 'detail-profile' post.uploader.id %}"><img class="rounded-circle" style="margin-right: 10px;" width="35" height="35" src="https://media.glomble.com/{{ post.uploader.profile_picture }}">
							{{ post.uploader.username }}
						</a>
						{% if post.uploader.username != user and request.user.is_authenticated %}
							<button class="follow-button {% if is_following %}following cool-element btn cool-element btn-outline-danger {% else %}cool-element btn cool-element btn-outline-success {% endif %}" data-url-add="{% url 'add-follower' post.uploader.id %}" data-url-remove="{% url 'remove-follower' post.uploader.id %}">
								{% if is_following %}
								<span>Following</span>
								{% else %}
								<span>Follow</span>
								{% endif %}
							</button>
						{% endif %}
					{% if has %}
					<div class="lmao format">
						{% if desclen <= 250 %}
						<p>
							{% autoescape off %}
							{{ post.description|linebreaksbr }}
							{% endautoescape %}
						</p>
						{% else %}
						<p>
							{{ pre|linebreaksbr }}<span id="dots">...</span><span id="more" style="display: none;">{{ readmore|linebreaksbr }}</span><button class="cool-element" style="background-color: transparent; border: none; box-shadow: none;" onclick="showmore()" id="myBtn"><b><i>Read more</i></b></button>
						</p>
						{% endif %}
					</div>
					{% endif %}
					<p>Views: <span class="view-count" id="{{ post.id }}">{{ post.views.count }}</span><br>
					Score: <span id="score">{{ post.score }}</span><br>
					Category: <span>{{ post.category }}</span></p>
					<p title="{{ post.date_posted }} (UTC)">{{ post.date_posted|naturaltime }}</p>
				<div class="row mt-3 mb-5 border-bottom">
					{% if request.user.is_authenticated %}
					<button style="background-color: transparent; border: none; box-shadow: none;" class="like-button cool-element" data-url="{% url 'video-like' post.id %}">
						{% if request.user in post.likes.all %}
						<i class="bx bxs-like cool-element"><span class="like-count">{{ post.likes.all.count }}</span></i>
						{% else %}
						<i class="bx bx-like cool-element"><span class="dislike-count">{{ post.likes.all.count }}</span></i>
						{% endif %}
					</button>
					<button style="background-color: transparent; border: none; box-shadow: none;" class="dislike-button cool-element" data-url="{% url 'video-dislike' post.id %}">
						{% if request.user in post.dislikes.all %}
						<i class="bx bxs-dislike cool-element"><span>{{ post.dislikes.all.count }}</span></i>
						{% else %}
						<i class="bx bx-dislike cool-element"><span>{{ post.dislikes.all.count }}</span></i>
						{% endif %}
					</button>
					<div class="col-md-6">
						<a class="video-icons icon-color" href="{% url 'video-download' post.id %}"><i class='bx bxs-download cool-element' ></i></a>
						{% if post.uploader.username != request.user %}
						<a class="video-icons icon-color" href="{% url 'video-report' post.id %}"><i class='bx bxs-flag-alt cool-element' ></i></a>
						{% endif %}
					</div>
					{% else %}
					<button class="cool-element" style="background-color: transparent; border: none; box-shadow: none;">
						<i class="bx bx-like cool-element"><span class="dislike-count">{{ post.likes.all.count }}</span></i>
					</button>
					<button class="cool-element" style="background-color: transparent; border: none; box-shadow: none;">
						<i class="bx bx-dislike cool-element"><span>{{ post.dislikes.all.count }}</span></i>
					</button>
					{% endif %}
				</div>
				<div class="row justify-content-center">
					<button onclick="onClickRecommend(this);" class="cool-element btn cool-element btn-outline-success">Recommend more videos</button>
				</div>
				<br>
				<div style="display: none;" class="row justify-content-center" id="recommended-videos">
				</div>
				<div class="row justify-content-center mt-3 mb-5">
					<div class="col-md-5 col-sm-12">
						<form id="comment-form" method="POST">
							{% if request.user.is_authenticated %}
							<legend id="cool" class="border-bottom mb-4">{{ comment_amount }} Comments</legend>
							{% csrf_token %}
							{{ form | crispy }}
							<input type="hidden" name="form_type" value="comment">
							<div class="d-grid gap-2">
								<button type="submit" class="cool-element btn cool-element btn-success mt-3">Submit!</button>
							</div>
							{% else %}
							<legend class="border-bottom mb-4">{{ comment_amount }} Comments</legend>
							{% endif %}
						</form>
					</div>
				</div>
					<div id="comments">
						{% include 'videos/comment.html' %}
					</div>
				</h6>
				<br>
			</div>
		</div>
	</div>
	<div id="notification" class="text-center" style="position: sticky; bottom: 0px; background-color: #c51717; z-index: 2;"></div>
	<script>
		function onClick(ele) {
			if (document.getElementById('reply'+ele.id).style.display === 'none') {
				document.getElementById('reply'+ele.id).style.display = 'block'
			}
			else {
				document.getElementById('reply'+ele.id).style.display = 'none'
			}
		}

        function updateViewCount(videoId) {
			globalThis.viewed = false
			$.ajax({
				type: "GET",
				url: `${videoId}/update-view-count/`,
				success: function(data) {
					$(".view-count").text(data.view_count);
					globalThis.viewed = data.viewed;
				},
			});
		}

		function onClickRecommend(ele) {
			const container = document.getElementById('recommended-videos');
			if (container.style.display === 'none') {
				container.style.display = 'flex';
			}
			$.ajax({
				type: "GET",
				url: `get-recommendations/{{ post.category }}`,
				success: function(data) {
					container.innerHTML = data.html;
				},
				error: function(xhr, status, error) {
					console.error("Error fetching recommendations.");
				}
			});
		}

		function onShowReplies(ele) {
			let id_thing = ele.id.split('-')[0]
			if (document.getElementById('replies'+id_thing).style.display === 'none') {
				document.getElementById('replies'+id_thing).style.display = 'block'
				ele.innerHTML = "Hide"
                ele.innerHTML += Number(ele.id.split('-')[1]) == 1 ? " reply" : " replies"
			}
			else {
				document.getElementById('replies'+id_thing).style.display = 'none'
				ele.innerHTML = "Show " + ele.id.split('-')[1]
                ele.innerHTML += Number(ele.id.split('-')[1]) == 1 ? " reply" : " replies" 
			}
		}

		function handleReplyForms() {
			const replyForms = document.querySelectorAll(".reply-form");
			globalThis.timer = 0;

			replyForms.forEach((form) => {
				form.addEventListener("submit", function (e) {
					e.preventDefault();
					const formData = new FormData(form);

					fetch(form.action, {
						method: "POST",
						headers: {
							"X-Requested-With": "XMLHttpRequest",
						},
						body: formData,
					})
						.then((response) => response.json())
						.then((data) => handleResponse(data, form));
				});
			});
		}

		$(document).ready(function() {
			const video = $("video")[0];
			const videoId = "{{ post.id }}";
			const progressKey = "video-progress-" + videoId;
			const volumeKey = "video-volume";

			handleReplyForms();
			formatText("format");

			$(document).on('click', '.timestamp', function(e) {
				e.preventDefault()
				
				$('html, body').animate({
					scrollTop: 0
				}, 500)
				const seconds = $(this).data('seconds')
				video.currentTime = seconds
				video.play()
			})

			if (localStorage.getItem(volumeKey)) {
				video.volume = parseFloat(localStorage.getItem(volumeKey));
			}

			if (localStorage.getItem(progressKey)) {
				video.currentTime = parseFloat(localStorage.getItem(progressKey));
			}

			video.addEventListener('volumechange', function() {
				localStorage.setItem(volumeKey, video.volume);
			});

			video.addEventListener('timeupdate', function() {
				localStorage.setItem(progressKey, video.currentTime);
			});

			video.addEventListener('ended', function() {
				localStorage.removeItem(progressKey);
			});
			
			function expandParentReplies($comment) {
				const parentContainers = $comment.parents('.reply-container');
				parentContainers.each(function() {
					if ($(this).is(":hidden")) {
						$(this).show();
					}
				});
			}

			function highlightComment(id) {
				const $comment = $(".comment-" + id);
				if ($comment.length) {
					expandParentReplies($comment);

					$('html, body').animate({
						scrollTop: $comment.offset().top - 100
					}, 500, function() {
						$comment.addClass('highlight');
						setTimeout(function() {
							$comment.removeClass('highlight');
						}, 1000);
					});
				}
			}

			const hash = window.location.hash;
			if (hash.startsWith("#comment=")) {
				const commentId = hash.split("=")[1];
				highlightComment(commentId);
			}

			const commentForm = document.getElementById("comment-form");
			globalThis.timer = 0;

			if (commentForm) {
				commentForm.addEventListener("submit", function (e) {
					e.preventDefault();
					const formData = new FormData(commentForm);

					fetch(commentForm.action, {
						method: "POST",
						headers: {
							"X-Requested-With": "XMLHttpRequest",
						},
						body: formData,
					})
						.then((response) => response.json())
						.then((data) => handleResponse(data, commentForm));
				});
			}

			var interval = setInterval(function() {
				if (globalThis.viewed == true) clearInterval(interval);
				updateViewCount(videoId);
			}, 1000);
			var interval2 = setInterval(function() {
				updateViewCount(videoId);
			}, 20000);
		});

		function handleResponse(data, form) {
			clearTimeout(globalThis.timer);
			const notification = document.getElementById("notification");
			const commentCount = document.getElementById("cool");
			const comments = document.getElementById("comments");

			if (!data.success) {
				notification.innerHTML = "Comment failed to post due to cooldown.";
				notification.style.backgroundColor = "#c51717";

				globalThis.timer = setTimeout(() => {
					notification.innerHTML = "";
				}, 2000);

				return;
			}

			notification.innerHTML = "Comment added!";
			notification.style.backgroundColor = "#32cd32";
			form.reset();

			globalThis.timer = setTimeout(() => {
					notification.innerHTML = "";
			}, 2000);

			commentCount.innerHTML = data.count + " Comments";

			comments.innerHTML = data.comments;

			handleReplyForms();
			formatText("format");
		}
	</script>
{% endblock content %}
