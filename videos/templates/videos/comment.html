{% load humanize %}
{% load count %}
{% load crispy_forms_tags %}

{% for comment in comments %}
    <div class="lmao row justify-content-center border-bottom mt-4 comment-{{ comment.pk }}">
        {% if pinned_comment == comment %}
        <h3><i title="Pinned" class='bx bxs-pin'></i></h3>
        {% endif %}
        <div class="col-md-9">
                <strong><a class="link-text cool-element" href="{% url 'detail-profile' comment.commenter.id %}">
                    <img class="rounded-circle" style="margin-left: -15px" width="35" height="35" src="https://media.glomble.com/{{ comment.commenter.profile_picture }}"> 
                    {{ comment.commenter.username }}
                    {% if comment.commenter.username.is_superuser %}
                    <i title="Admin" class='bx bxs-user-badge'></i>
                    {% endif %}</a></strong>
                <i style="margin-left: 1%;" title="{{ comment.date_posted }} (UTC)">{{ comment.date_posted|naturaltime }}</i>
                {% if request.user == comment.commenter.username %}
                    <a class="cool-element btn cool-element btn-outline-primary" href="{% url 'comments:comment-update' comment.pk %}">Edit</a>
					<a class="cool-element btn cool-element btn-outline-danger" href="{% url 'comments:comment-delete' comment.pk %}">Delete</a>
                {% elif request.user.is_superuser %}
					<a class="cool-element btn cool-element btn-outline-danger" href="{% url 'comments:comment-delete' comment.pk %}">Delete</a>
				{% endif %}
                {% if post.uploader.username in comment.likes.all %}
                    <i class="bx bxs-heart" title="Liked by uploader"></i>
                {% endif %}
                {% if request.user.is_authenticated %}
                <div class="row mt-3">
                    <button style="background-color: transparent; border: none; box-shadow: none;" class="comment-like-button cool-element" data-url="{% url 'comments:comment-like' comment.pk %}">
                        {% if request.user in comment.likes.all %}
                        <i class="bx bxs-like cool-element"><span class="comment-like-count" id="{{ comment.pk }}-like">{{ comment.likes.all.count }}</span></i>
                        {% else %}
                        <i class="bx bx-like cool-element"><span class="comment-dislike-count" id="{{ comment.pk }}-dislike">{{ comment.likes.all.count }}</span></i>
                        {% endif %}
                    </button>
                    <button style="background-color: transparent; border: none; box-shadow: none;" class="comment-dislike-button cool-element" data-url="{% url 'comments:comment-dislike' comment.pk %}">
                        {% if request.user in comment.dislikes.all %}
                        <i class="bx bxs-dislike cool-element"><span>{{ comment.dislikes.all.count }}</span></i>
                        {% else %}
                        <i class="bx bx-dislike cool-element"><span>{{ comment.dislikes.all.count }}</span></i>
                        {% endif %}
                    </button>
                </div>
                {% else %}
                <div class="row mt-3">
                    <button style="background-color: transparent; border: none; box-shadow: none;">
                        <i class="bx bx-like cool-element"><span class="dislike-count">{{ comment.likes.all.count }}</span></i>
                    </button>
                    <button style="background-color: transparent; border: none; box-shadow: none;">
                        <i class="bx bx-dislike cool-element"><span>{{ comment.dislikes.all.count }}</span></i>
                    </button>
                </div>
                {% endif %}
                <br>
                <p class="lmao format">{% autoescape off %}{{ comment.comment|linebreaksbr }}{% endautoescape %}</p>
                {% if post.uploader.username == request.user %}
                <a class="cool-element btn cool-element btn-outline-primary" href="{% url 'comments:comment-pin' comment.pk %}"><i class='bx bx-pin'></i></a>
                {% endif %}
                <button id="{{ comment.pk }}" onclick="onClick(this)" class="cool-element btn btn-outline-success"><i class='bx bx-comment-detail'></i></button>
                <button onclick="copyUrl(`{% if request.is_secure %}https://{% else %}http://{% endif %}{{ request.get_host }}{% url 'video-detail' comment.post.id %}#comment={{ comment.pk }}`)" class="cool-element btn cool-element btn-outline-primary"><i class='bx bx-share'></i></button>

                {% has_replies comment.pk as has_replies %}
                {% if has_replies %}
                {% reply_count comment.pk as count_replies %}
                <button id="{{ comment.pk }}-{{ count_replies }}" onclick="onShowReplies(this);" class="cool-element btn btn-outline-info">Show {{ count_replies }} {% if count_replies == 1 %}reply{% else %}replies{% endif %}</button>
                {% endif %}

                <div class="reply" style="display: none;" id="reply{{ comment.pk }}">
                    <form class="reply-form" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="reply">
                        <input type="hidden" name="comment_id" value="{{comment.pk}}">
                        {{ replyform | crispy }}
                        <div class="d-grid gap-2">
                            <button type="submit" class="cool-element btn btn-success mt-3">Submit!</button>
                        </div>
                    </form>
                </div>
                {% with comment_replies=replies|dictsort:"date_posted" %}
                {% if comment_replies %}
                <div style="display: none;" class="lmao reply-container" id="replies{{ comment.pk }}">
                    {% for reply in comment_replies %}
                        {% if reply.replying_to and reply.replying_to.id == comment.pk %}
                        <div class="row justify-content-center comment-{{ reply.pk }}">
                            <div class="col-md-9">
                                    <strong>
                                        <a class="link-text cool-element" href="{% url 'detail-profile' reply.commenter.id %}">
                                            <img class="rounded-circle" style="margin-left: -15px" width="35" height="35" src="https://media.glomble.com/{{ reply.commenter.profile_picture }}">
                                            {{ reply.commenter.username }}
                                            {% if reply.commenter.username.is_superuser %}
                                            <i title="Admin" class='bx bxs-user-badge' ></i>
                                            {% endif %}</a></strong>
                                        </a>
                                    </strong> 
                                    <i title="{{ reply.date_posted }}">{{ reply.date_posted|naturaltime }}</i>
                                    {% if request.user == reply.commenter.username %}
                                        <a class="cool-element btn cool-element btn-outline-primary" href="{% url 'comments:comment-update' reply.pk %}">Edit</a>
                                        <a class="cool-element btn cool-element btn-outline-danger" href="{% url 'comments:comment-delete' reply.pk %}">Delete</a>
                                    {% elif request.user.is_superuser %}
                                        <a class="cool-element btn cool-element btn-outline-danger" href="{% url 'comments:comment-delete' reply.pk %}">Delete</a>
                                    {% endif %}
                                    {% if post.uploader.username in reply.likes.all %}
                                        <i class="bx bxs-heart" title="Liked by uploader"></i>
                                    {% endif %}
                                {% if request.user.is_authenticated %}
                                <div class="row mt-3">
                                    <button style="background-color: transparent; border: none; box-shadow: none;" class="comment-like-button" data-url="{% url 'comments:comment-like' reply.pk %}">
                                        {% if request.user in reply.likes.all %}
                                        <i class="bx bxs-like cool-element"><span class="reply-like-count" id="{{ reply.pk }}-like">{{ reply.likes.all.count }}</span></i>
                                        {% else %}
                                        <i class="bx bx-like cool-element"><span class="reply-dislike-count" id="{{ reply.pk }}-dislike">{{ reply.likes.all.count }}</span></i>
                                        {% endif %}
                                    </button>
                                    <button style="background-color: transparent; border: none; box-shadow: none;" class="comment-dislike-button" data-url="{% url 'comments:comment-dislike' reply.pk %}">
                                        {% if request.user in reply.dislikes.all %}
                                        <i class="bx bxs-dislike cool-element"><span>{{ reply.dislikes.all.count }}</span></i>
                                        {% else %}
                                        <i class="bx bx-dislike cool-element"><span>{{ reply.dislikes.all.count }}</span></i>
                                        {% endif %}
                                    </button>
                                </div>
                                {% else %}
                                <div class="row mt-3">
                                    <button style="background-color: transparent; border: none; box-shadow: none;">
                                        <i class="bx bx-like cool-element"><span class="dislike-count">{{ reply.likes.all.count }}</span></i>
                                    </button>
                                    <button style="background-color: transparent; border: none; box-shadow: none;">
                                        <i class="bx bx-dislike cool-element"><span>{{ reply.dislikes.all.count }}</span></i>
                                    </button>
                                </div>
                                {% endif %}
                                <br>
                                <p class="format">{% autoescape off %}{{ reply.comment|linebreaksbr }}{% endautoescape %}</p>
                                <button onclick="copyUrl(`{% if request.is_secure %}https://{% else %}http://{% endif %}{{ request.get_host }}{% url 'video-detail' comment.post.id %}#comment={{ reply.pk }}`)" class="cool-element btn cool-element btn-outline-primary"><i class='bx bx-share'></i></button>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            {% endwith %}
        </div>
    </div>
{% endfor %}